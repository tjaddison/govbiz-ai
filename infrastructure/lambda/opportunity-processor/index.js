"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_sqs_1 = require("@aws-sdk/client-sqs");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
// Initialize AWS clients
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const sqsClient = new client_sqs_1.SQSClient({});
const eventBridgeClient = new client_eventbridge_1.EventBridgeClient({});
// Environment variables
const { OPPORTUNITY_TABLE, USER_TABLE, EVENT_BUS, MESSAGE_QUEUE, } = process.env;
// Utility functions
const calculateMatchScore = (opportunity, user) => {
    let score = 0;
    const reasons = [];
    // NAICS code match (highest weight)
    if (user.naicsCodes.includes(opportunity.naicsCode)) {
        score += 50;
        reasons.push('NAICS code match');
    }
    // Keyword matches
    const keywordMatches = opportunity.keywords.filter(keyword => user.keywords.some(userKeyword => keyword.toLowerCase().includes(userKeyword.toLowerCase()) ||
        userKeyword.toLowerCase().includes(keyword.toLowerCase())));
    score += keywordMatches.length * 10;
    if (keywordMatches.length > 0) {
        reasons.push(`${keywordMatches.length} keyword matches`);
    }
    // Agency preference
    if (user.agencies.includes(opportunity.agency)) {
        score += 20;
        reasons.push('Preferred agency');
    }
    // Set-aside match
    if (opportunity.setAsideCode && user.certifications.includes(opportunity.setAsideCode)) {
        score += 30;
        reasons.push('Certification match');
    }
    // Title/description keyword match
    const titleDescriptionText = `${opportunity.title} ${opportunity.description}`.toLowerCase();
    const titleMatches = user.keywords.filter(keyword => titleDescriptionText.includes(keyword.toLowerCase()));
    score += titleMatches.length * 5;
    if (titleMatches.length > 0) {
        reasons.push(`${titleMatches.length} title/description matches`);
    }
    return Math.min(score, 100); // Cap at 100
};
const findMatchingUsers = async (opportunity) => {
    const matches = [];
    try {
        // Query users who have the same NAICS code
        const naicsUsers = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: USER_TABLE,
            IndexName: 'naics-index', // Assumes GSI exists
            KeyConditionExpression: 'naicsCode = :naicsCode',
            ExpressionAttributeValues: {
                ':naicsCode': opportunity.naicsCode,
            },
        }));
        // Also scan for users with keyword matches (expensive, but necessary)
        // In production, consider using OpenSearch or similar for text search
        const allUsers = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: USER_TABLE,
            // This would need to be a more sophisticated query in production
        }));
        const users = [...(naicsUsers.Items || []), ...(allUsers.Items || [])];
        const uniqueUsers = users.filter((user, index, self) => index === self.findIndex(u => u.userId === user.userId));
        for (const user of uniqueUsers) {
            const matchScore = calculateMatchScore(opportunity, user);
            if (matchScore >= 30) { // Minimum threshold for notification
                matches.push({
                    userId: user.userId,
                    opportunityId: opportunity.opportunityId,
                    matchScore,
                    matchReasons: [], // Would be populated by calculateMatchScore
                    notificationSent: false,
                    createdAt: new Date().toISOString(),
                });
            }
        }
        return matches;
    }
    catch (error) {
        console.error('Error finding matching users:', error);
        return [];
    }
};
const processOpportunity = async (opportunity) => {
    try {
        // Store opportunity in DynamoDB
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: OPPORTUNITY_TABLE,
            Item: {
                ...opportunity,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
            },
        }));
        // Find matching users
        const matches = await findMatchingUsers(opportunity);
        // Store matches and queue notifications
        for (const match of matches) {
            // Store match record
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: `${OPPORTUNITY_TABLE}-matches`, // Separate table for matches
                Item: match,
            }));
            // Queue notification
            await sqsClient.send(new client_sqs_1.SendMessageCommand({
                QueueUrl: MESSAGE_QUEUE,
                MessageBody: JSON.stringify({
                    type: 'opportunity_notification',
                    data: {
                        userId: match.userId,
                        opportunityId: match.opportunityId,
                        matchScore: match.matchScore,
                        matchReasons: match.matchReasons,
                    },
                }),
            }));
        }
        // Publish event to EventBridge
        await eventBridgeClient.send(new client_eventbridge_1.PutEventsCommand({
            Entries: [{
                    Source: 'govbiz.opportunities',
                    DetailType: 'Opportunity Processed',
                    Detail: JSON.stringify({
                        opportunityId: opportunity.opportunityId,
                        title: opportunity.title,
                        agency: opportunity.agency,
                        naicsCode: opportunity.naicsCode,
                        matchCount: matches.length,
                        processedAt: new Date().toISOString(),
                    }),
                    EventBusName: EVENT_BUS,
                }],
        }));
        console.log(`Processed opportunity ${opportunity.opportunityId} with ${matches.length} matches`);
    }
    catch (error) {
        console.error('Error processing opportunity:', error);
        throw error;
    }
};
const processSAMGovData = async (samData) => {
    // Transform SAM.gov data to our internal format
    return {
        opportunityId: samData.noticeId || `ss-${Date.now()}`,
        title: samData.title || 'Untitled Opportunity',
        description: samData.description || '',
        agency: samData.department || 'Unknown Agency',
        office: samData.office || 'Unknown Office',
        naicsCode: samData.naicsCode || '000000',
        naicsDescription: samData.naicsDescription || 'Unknown NAICS',
        setAsideCode: samData.setAside,
        postedDate: samData.postedDate || new Date().toISOString(),
        responseDeadline: samData.responseDeadline || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
        pointOfContact: {
            name: samData.contactName || 'Unknown Contact',
            email: samData.contactEmail || 'unknown@agency.gov',
            phone: samData.contactPhone,
        },
        requirements: samData.requirements || [],
        attachments: samData.attachments || [],
        solicitationNumber: samData.solicitationNumber,
        estimatedValue: samData.estimatedValue,
        placeOfPerformance: samData.placeOfPerformance,
        status: 'active',
        keywords: extractKeywords(samData.title + ' ' + samData.description),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
    };
};
const extractKeywords = (text) => {
    // Simple keyword extraction - in production, use NLP
    const stopWords = ['the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'a', 'an'];
    const words = text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 3 && !stopWords.includes(word));
    return [...new Set(words)].slice(0, 20); // Limit to 20 unique keywords
};
// Main handler
const handler = async (event, context) => {
    console.log('Event:', JSON.stringify(event, null, 2));
    for (const record of event.Records) {
        try {
            const messageBody = JSON.parse(record.body);
            switch (messageBody.type) {
                case 'sam_gov_data':
                    const opportunity = await processSAMGovData(messageBody.data);
                    await processOpportunity(opportunity);
                    break;
                case 'opportunity_update':
                    // Handle opportunity updates
                    await docClient.send(new lib_dynamodb_1.UpdateCommand({
                        TableName: OPPORTUNITY_TABLE,
                        Key: { opportunityId: messageBody.data.opportunityId },
                        UpdateExpression: 'SET #status = :status, updatedAt = :updatedAt',
                        ExpressionAttributeNames: {
                            '#status': 'status',
                        },
                        ExpressionAttributeValues: {
                            ':status': messageBody.data.status,
                            ':updatedAt': new Date().toISOString(),
                        },
                    }));
                    break;
                default:
                    console.warn('Unknown message type:', messageBody.type);
            }
        }
        catch (error) {
            console.error('Error processing record:', error);
            // In production, implement dead letter queue handling
            throw error;
        }
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQXdHO0FBQ3hHLG9EQUFvRTtBQUNwRSxvRUFBa0Y7QUFFbEYseUJBQXlCO0FBQ3pCLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDNUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVwRCx3QkFBd0I7QUFDeEIsTUFBTSxFQUNKLGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsU0FBUyxFQUNULGFBQWEsR0FDZCxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7QUF1RGhCLG9CQUFvQjtBQUNwQixNQUFNLG1CQUFtQixHQUFHLENBQUMsV0FBcUMsRUFBRSxJQUFpQixFQUFVLEVBQUU7SUFDL0YsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDO0lBRTdCLG9DQUFvQztJQUNwQyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1FBQ3BELEtBQUssSUFBSSxFQUFFLENBQUM7UUFDWixPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELGtCQUFrQjtJQUNsQixNQUFNLGNBQWMsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUMv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QzVCLEdBQUcsRUFBRSxFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTt3QkFDdEQsZ0JBQWdCLEVBQUUsK0NBQStDO3dCQUNqRSx3QkFBd0IsRUFBRTs0QkFDeEIsU0FBUyxFQUFFLFFBQVE7eUJBQ3BCO3dCQUNELHlCQUF5QixFQUFFOzRCQUN6QixTQUFTLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNOzRCQUNsQyxZQUFZLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7eUJBQ3ZDO3FCQUNGLENBQUMsQ0FBQyxDQUFDO29CQUNKLE1BQU07Z0JBRVI7b0JBQ0UsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUQsQ0FBQztRQUNILENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNqRCxzREFBc0Q7WUFDdEQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztBQUNILENBQUMsQ0FBQztBQXRDVyxRQUFBLE9BQU8sV0FzQ2xCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU1FTRXZlbnQsIFNRU1JlY29yZCwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFNRU0NsaWVudCwgU2VuZE1lc3NhZ2VDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNxcyc7XG5pbXBvcnQgeyBFdmVudEJyaWRnZUNsaWVudCwgUHV0RXZlbnRzQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1ldmVudGJyaWRnZSc7XG5cbi8vIEluaXRpYWxpemUgQVdTIGNsaWVudHNcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IHNxc0NsaWVudCA9IG5ldyBTUVNDbGllbnQoe30pO1xuY29uc3QgZXZlbnRCcmlkZ2VDbGllbnQgPSBuZXcgRXZlbnRCcmlkZ2VDbGllbnQoe30pO1xuXG4vLyBFbnZpcm9ubWVudCB2YXJpYWJsZXNcbmNvbnN0IHtcbiAgT1BQT1JUVU5JVFlfVEFCTEUsXG4gIFVTRVJfVEFCTEUsXG4gIEVWRU5UX0JVUyxcbiAgTUVTU0FHRV9RVUVVRSxcbn0gPSBwcm9jZXNzLmVudjtcblxuLy8gVHlwZXNcbmludGVyZmFjZSBTb3VyY2VzU291Z2h0T3Bwb3J0dW5pdHkge1xuICBvcHBvcnR1bml0eUlkOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIGFnZW5jeTogc3RyaW5nO1xuICBvZmZpY2U6IHN0cmluZztcbiAgbmFpY3NDb2RlOiBzdHJpbmc7XG4gIG5haWNzRGVzY3JpcHRpb246IHN0cmluZztcbiAgc2V0QXNpZGVDb2RlPzogc3RyaW5nO1xuICBwb3N0ZWREYXRlOiBzdHJpbmc7XG4gIHJlc3BvbnNlRGVhZGxpbmU6IHN0cmluZztcbiAgcG9pbnRPZkNvbnRhY3Q6IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZW1haWw6IHN0cmluZztcbiAgICBwaG9uZT86IHN0cmluZztcbiAgfTtcbiAgcmVxdWlyZW1lbnRzOiBzdHJpbmdbXTtcbiAgYXR0YWNobWVudHM/OiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIHVybDogc3RyaW5nO1xuICB9W107XG4gIHNvbGljaXRhdGlvbk51bWJlcj86IHN0cmluZztcbiAgZXN0aW1hdGVkVmFsdWU/OiBzdHJpbmc7XG4gIHBsYWNlT2ZQZXJmb3JtYW5jZT86IHN0cmluZztcbiAgc3RhdHVzOiAnYWN0aXZlJyB8ICdjYW5jZWxsZWQnIHwgJ2F3YXJkZWQnIHwgJ2V4cGlyZWQnO1xuICBrZXl3b3Jkczogc3RyaW5nW107XG4gIGNyZWF0ZWRBdDogc3RyaW5nO1xuICB1cGRhdGVkQXQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFVzZXJQcm9maWxlIHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIG5haWNzQ29kZXM6IHN0cmluZ1tdO1xuICBrZXl3b3Jkczogc3RyaW5nW107XG4gIGFnZW5jaWVzOiBzdHJpbmdbXTtcbiAgY2VydGlmaWNhdGlvbnM6IHN0cmluZ1tdO1xuICBhbGVydFByZWZlcmVuY2VzOiB7XG4gICAgZW1haWw6IGJvb2xlYW47XG4gICAgc21zOiBib29sZWFuO1xuICAgIHB1c2g6IGJvb2xlYW47XG4gIH07XG59XG5cbmludGVyZmFjZSBPcHBvcnR1bml0eU1hdGNoIHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIG9wcG9ydHVuaXR5SWQ6IHN0cmluZztcbiAgbWF0Y2hTY29yZTogbnVtYmVyO1xuICBtYXRjaFJlYXNvbnM6IHN0cmluZ1tdO1xuICBub3RpZmljYXRpb25TZW50OiBib29sZWFuO1xuICBjcmVhdGVkQXQ6IHN0cmluZztcbn1cblxuLy8gVXRpbGl0eSBmdW5jdGlvbnNcbmNvbnN0IGNhbGN1bGF0ZU1hdGNoU2NvcmUgPSAob3Bwb3J0dW5pdHk6IFNvdXJjZXNTb3VnaHRPcHBvcnR1bml0eSwgdXNlcjogVXNlclByb2ZpbGUpOiBudW1iZXIgPT4ge1xuICBsZXQgc2NvcmUgPSAwO1xuICBjb25zdCByZWFzb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gIC8vIE5BSUNTIGNvZGUgbWF0Y2ggKGhpZ2hlc3Qgd2VpZ2h0KVxuICBpZiAodXNlci5uYWljc0NvZGVzLmluY2x1ZGVzKG9wcG9ydHVuaXR5Lm5haWNzQ29kZSkpIHtcbiAgICBzY29yZSArPSA1MDtcbiAgICByZWFzb25zLnB1c2goJ05BSUNTIGNvZGUgbWF0Y2gnKTtcbiAgfVxuXG4gIC8vIEtleXdvcmQgbWF0Y2hlc1xuICBjb25zdCBrZXl3b3JkTWF0Y2hlcyA9IG9wcG9ydHVuaXR5LmtleXdvcmRzLmZpbHRlcihrZXl3b3JkID0+IFxuICAgIHVzZXIua2V5d29yZHMuc29tZSh1c2VyS2V5d29yZCA9PiBcbiAgICAgIGtleXdvcmQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyh1c2VyS2V5d29yZC50b0xvd2VyQ2FzZSgpKSB8fFxuICAgICAgdXNlcktleXdvcmQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhrZXl3b3JkLnRvTG93ZXJDYXNlKCkpXG4gICAgKVxuICApO1xuICBzY29yZSArPSBrZXl3b3JkTWF0Y2hlcy5sZW5ndGggKiAxMDtcbiAgaWYgKGtleXdvcmRNYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICByZWFzb25zLnB1c2goYCR7a2V5d29yZE1hdGNoZXMubGVuZ3RofSBrZXl3b3JkIG1hdGNoZXNgKTtcbiAgfVxuXG4gIC8vIEFnZW5jeSBwcmVmZXJlbmNlXG4gIGlmICh1c2VyLmFnZW5jaWVzLmluY2x1ZGVzKG9wcG9ydHVuaXR5LmFnZW5jeSkpIHtcbiAgICBzY29yZSArPSAyMDtcbiAgICByZWFzb25zLnB1c2goJ1ByZWZlcnJlZCBhZ2VuY3knKTtcbiAgfVxuXG4gIC8vIFNldC1hc2lkZSBtYXRjaFxuICBpZiAob3Bwb3J0dW5pdHkuc2V0QXNpZGVDb2RlICYmIHVzZXIuY2VydGlmaWNhdGlvbnMuaW5jbHVkZXMob3Bwb3J0dW5pdHkuc2V0QXNpZGVDb2RlKSkge1xuICAgIHNjb3JlICs9IDMwO1xuICAgIHJlYXNvbnMucHVzaCgnQ2VydGlmaWNhdGlvbiBtYXRjaCcpO1xuICB9XG5cbiAgLy8gVGl0bGUvZGVzY3JpcHRpb24ga2V5d29yZCBtYXRjaFxuICBjb25zdCB0aXRsZURlc2NyaXB0aW9uVGV4dCA9IGAke29wcG9ydHVuaXR5LnRpdGxlfSAke29wcG9ydHVuaXR5LmRlc2NyaXB0aW9ufWAudG9Mb3dlckNhc2UoKTtcbiAgY29uc3QgdGl0bGVNYXRjaGVzID0gdXNlci5rZXl3b3Jkcy5maWx0ZXIoa2V5d29yZCA9PiBcbiAgICB0aXRsZURlc2NyaXB0aW9uVGV4dC5pbmNsdWRlcyhrZXl3b3JkLnRvTG93ZXJDYXNlKCkpXG4gICk7XG4gIHNjb3JlICs9IHRpdGxlTWF0Y2hlcy5sZW5ndGggKiA1O1xuICBpZiAodGl0bGVNYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICByZWFzb25zLnB1c2goYCR7dGl0bGVNYXRjaGVzLmxlbmd0aH0gdGl0bGUvZGVzY3JpcHRpb24gbWF0Y2hlc2ApO1xuICB9XG5cbiAgcmV0dXJuIE1hdGgubWluKHNjb3JlLCAxMDApOyAvLyBDYXAgYXQgMTAwXG59O1xuXG5jb25zdCBmaW5kTWF0Y2hpbmdVc2VycyA9IGFzeW5jIChvcHBvcnR1bml0eTogU291cmNlc1NvdWdodE9wcG9ydHVuaXR5KTogUHJvbWlzZTxPcHBvcnR1bml0eU1hdGNoW10+ID0+IHtcbiAgY29uc3QgbWF0Y2hlczogT3Bwb3J0dW5pdHlNYXRjaFtdID0gW107XG5cbiAgdHJ5IHtcbiAgICAvLyBRdWVyeSB1c2VycyB3aG8gaGF2ZSB0aGUgc2FtZSBOQUlDUyBjb2RlXG4gICAgY29uc3QgbmFpY3NVc2VycyA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBVU0VSX1RBQkxFLFxuICAgICAgSW5kZXhOYW1lOiAnbmFpY3MtaW5kZXgnLCAvLyBBc3N1bWVzIEdTSSBleGlzdHNcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICduYWljc0NvZGUgPSA6bmFpY3NDb2RlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpuYWljc0NvZGUnOiBvcHBvcnR1bml0eS5uYWljc0NvZGUsXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIC8vIEFsc28gc2NhbiBmb3IgdXNlcnMgd2l0aCBrZXl3b3JkIG1hdGNoZXMgKGV4cGVuc2l2ZSwgYnV0IG5lY2Vzc2FyeSlcbiAgICAvLyBJbiBwcm9kdWN0aW9uLCBjb25zaWRlciB1c2luZyBPcGVuU2VhcmNoIG9yIHNpbWlsYXIgZm9yIHRleHQgc2VhcmNoXG4gICAgY29uc3QgYWxsVXNlcnMgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVVNFUl9UQUJMRSxcbiAgICAgIC8vIFRoaXMgd291bGQgbmVlZCB0byBiZSBhIG1vcmUgc29waGlzdGljYXRlZCBxdWVyeSBpbiBwcm9kdWN0aW9uXG4gICAgfSkpO1xuXG4gICAgY29uc3QgdXNlcnMgPSBbLi4uKG5haWNzVXNlcnMuSXRlbXMgfHwgW10pLCAuLi4oYWxsVXNlcnMuSXRlbXMgfHwgW10pXTtcbiAgICBjb25zdCB1bmlxdWVVc2VycyA9IHVzZXJzLmZpbHRlcigodXNlciwgaW5kZXgsIHNlbGYpID0+IFxuICAgICAgaW5kZXggPT09IHNlbGYuZmluZEluZGV4KHUgPT4gdS51c2VySWQgPT09IHVzZXIudXNlcklkKVxuICAgICk7XG5cbiAgICBmb3IgKGNvbnN0IHVzZXIgb2YgdW5pcXVlVXNlcnMpIHtcbiAgICAgIGNvbnN0IG1hdGNoU2NvcmUgPSBjYWxjdWxhdGVNYXRjaFNjb3JlKG9wcG9ydHVuaXR5LCB1c2VyIGFzIFVzZXJQcm9maWxlKTtcbiAgICAgIFxuICAgICAgaWYgKG1hdGNoU2NvcmUgPj0gMzApIHsgLy8gTWluaW11bSB0aHJlc2hvbGQgZm9yIG5vdGlmaWNhdGlvblxuICAgICAgICBtYXRjaGVzLnB1c2goe1xuICAgICAgICAgIHVzZXJJZDogdXNlci51c2VySWQsXG4gICAgICAgICAgb3Bwb3J0dW5pdHlJZDogb3Bwb3J0dW5pdHkub3Bwb3J0dW5pdHlJZCxcbiAgICAgICAgICBtYXRjaFNjb3JlLFxuICAgICAgICAgIG1hdGNoUmVhc29uczogW10sIC8vIFdvdWxkIGJlIHBvcHVsYXRlZCBieSBjYWxjdWxhdGVNYXRjaFNjb3JlXG4gICAgICAgICAgbm90aWZpY2F0aW9uU2VudDogZmFsc2UsXG4gICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtYXRjaGVzO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZpbmRpbmcgbWF0Y2hpbmcgdXNlcnM6JywgZXJyb3IpO1xuICAgIHJldHVybiBbXTtcbiAgfVxufTtcblxuY29uc3QgcHJvY2Vzc09wcG9ydHVuaXR5ID0gYXN5bmMgKG9wcG9ydHVuaXR5OiBTb3VyY2VzU291Z2h0T3Bwb3J0dW5pdHkpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBTdG9yZSBvcHBvcnR1bml0eSBpbiBEeW5hbW9EQlxuICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBQdXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogT1BQT1JUVU5JVFlfVEFCTEUsXG4gICAgICBJdGVtOiB7XG4gICAgICAgIC4uLm9wcG9ydHVuaXR5LFxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIC8vIEZpbmQgbWF0Y2hpbmcgdXNlcnNcbiAgICBjb25zdCBtYXRjaGVzID0gYXdhaXQgZmluZE1hdGNoaW5nVXNlcnMob3Bwb3J0dW5pdHkpO1xuXG4gICAgLy8gU3RvcmUgbWF0Y2hlcyBhbmQgcXVldWUgbm90aWZpY2F0aW9uc1xuICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgbWF0Y2hlcykge1xuICAgICAgLy8gU3RvcmUgbWF0Y2ggcmVjb3JkXG4gICAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUHV0Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogYCR7T1BQT1JUVU5JVFlfVEFCTEV9LW1hdGNoZXNgLCAvLyBTZXBhcmF0ZSB0YWJsZSBmb3IgbWF0Y2hlc1xuICAgICAgICBJdGVtOiBtYXRjaCxcbiAgICAgIH0pKTtcblxuICAgICAgLy8gUXVldWUgbm90aWZpY2F0aW9uXG4gICAgICBhd2FpdCBzcXNDbGllbnQuc2VuZChuZXcgU2VuZE1lc3NhZ2VDb21tYW5kKHtcbiAgICAgICAgUXVldWVVcmw6IE1FU1NBR0VfUVVFVUUsXG4gICAgICAgIE1lc3NhZ2VCb2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgdHlwZTogJ29wcG9ydHVuaXR5X25vdGlmaWNhdGlvbicsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgdXNlcklkOiBtYXRjaC51c2VySWQsXG4gICAgICAgICAgICBvcHBvcnR1bml0eUlkOiBtYXRjaC5vcHBvcnR1bml0eUlkLFxuICAgICAgICAgICAgbWF0Y2hTY29yZTogbWF0Y2gubWF0Y2hTY29yZSxcbiAgICAgICAgICAgIG1hdGNoUmVhc29uczogbWF0Y2gubWF0Y2hSZWFzb25zLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8vIFB1Ymxpc2ggZXZlbnQgdG8gRXZlbnRCcmlkZ2VcbiAgICBhd2FpdCBldmVudEJyaWRnZUNsaWVudC5zZW5kKG5ldyBQdXRFdmVudHNDb21tYW5kKHtcbiAgICAgIEVudHJpZXM6IFt7XG4gICAgICAgIFNvdXJjZTogJ2dvdmJpei5vcHBvcnR1bml0aWVzJyxcbiAgICAgICAgRGV0YWlsVHlwZTogJ09wcG9ydHVuaXR5IFByb2Nlc3NlZCcsXG4gICAgICAgIERldGFpbDogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIG9wcG9ydHVuaXR5SWQ6IG9wcG9ydHVuaXR5Lm9wcG9ydHVuaXR5SWQsXG4gICAgICAgICAgdGl0bGU6IG9wcG9ydHVuaXR5LnRpdGxlLFxuICAgICAgICAgIGFnZW5jeTogb3Bwb3J0dW5pdHkuYWdlbmN5LFxuICAgICAgICAgIG5haWNzQ29kZTogb3Bwb3J0dW5pdHkubmFpY3NDb2RlLFxuICAgICAgICAgIG1hdGNoQ291bnQ6IG1hdGNoZXMubGVuZ3RoLFxuICAgICAgICAgIHByb2Nlc3NlZEF0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIH0pLFxuICAgICAgICBFdmVudEJ1c05hbWU6IEVWRU5UX0JVUyxcbiAgICAgIH1dLFxuICAgIH0pKTtcblxuICAgIGNvbnNvbGUubG9nKGBQcm9jZXNzZWQgb3Bwb3J0dW5pdHkgJHtvcHBvcnR1bml0eS5vcHBvcnR1bml0eUlkfSB3aXRoICR7bWF0Y2hlcy5sZW5ndGh9IG1hdGNoZXNgKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIG9wcG9ydHVuaXR5OicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufTtcblxuY29uc3QgcHJvY2Vzc1NBTUdvdkRhdGEgPSBhc3luYyAoc2FtRGF0YTogYW55KTogUHJvbWlzZTxTb3VyY2VzU291Z2h0T3Bwb3J0dW5pdHk+ID0+IHtcbiAgLy8gVHJhbnNmb3JtIFNBTS5nb3YgZGF0YSB0byBvdXIgaW50ZXJuYWwgZm9ybWF0XG4gIHJldHVybiB7XG4gICAgb3Bwb3J0dW5pdHlJZDogc2FtRGF0YS5ub3RpY2VJZCB8fCBgc3MtJHtEYXRlLm5vdygpfWAsXG4gICAgdGl0bGU6IHNhbURhdGEudGl0bGUgfHwgJ1VudGl0bGVkIE9wcG9ydHVuaXR5JyxcbiAgICBkZXNjcmlwdGlvbjogc2FtRGF0YS5kZXNjcmlwdGlvbiB8fCAnJyxcbiAgICBhZ2VuY3k6IHNhbURhdGEuZGVwYXJ0bWVudCB8fCAnVW5rbm93biBBZ2VuY3knLFxuICAgIG9mZmljZTogc2FtRGF0YS5vZmZpY2UgfHwgJ1Vua25vd24gT2ZmaWNlJyxcbiAgICBuYWljc0NvZGU6IHNhbURhdGEubmFpY3NDb2RlIHx8ICcwMDAwMDAnLFxuICAgIG5haWNzRGVzY3JpcHRpb246IHNhbURhdGEubmFpY3NEZXNjcmlwdGlvbiB8fCAnVW5rbm93biBOQUlDUycsXG4gICAgc2V0QXNpZGVDb2RlOiBzYW1EYXRhLnNldEFzaWRlLFxuICAgIHBvc3RlZERhdGU6IHNhbURhdGEucG9zdGVkRGF0ZSB8fCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgcmVzcG9uc2VEZWFkbGluZTogc2FtRGF0YS5yZXNwb25zZURlYWRsaW5lIHx8IG5ldyBEYXRlKERhdGUubm93KCkgKyAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApLnRvSVNPU3RyaW5nKCksXG4gICAgcG9pbnRPZkNvbnRhY3Q6IHtcbiAgICAgIG5hbWU6IHNhbURhdGEuY29udGFjdE5hbWUgfHwgJ1Vua25vd24gQ29udGFjdCcsXG4gICAgICBlbWFpbDogc2FtRGF0YS5jb250YWN0RW1haWwgfHwgJ3Vua25vd25AYWdlbmN5LmdvdicsXG4gICAgICBwaG9uZTogc2FtRGF0YS5jb250YWN0UGhvbmUsXG4gICAgfSxcbiAgICByZXF1aXJlbWVudHM6IHNhbURhdGEucmVxdWlyZW1lbnRzIHx8IFtdLFxuICAgIGF0dGFjaG1lbnRzOiBzYW1EYXRhLmF0dGFjaG1lbnRzIHx8IFtdLFxuICAgIHNvbGljaXRhdGlvbk51bWJlcjogc2FtRGF0YS5zb2xpY2l0YXRpb25OdW1iZXIsXG4gICAgZXN0aW1hdGVkVmFsdWU6IHNhbURhdGEuZXN0aW1hdGVkVmFsdWUsXG4gICAgcGxhY2VPZlBlcmZvcm1hbmNlOiBzYW1EYXRhLnBsYWNlT2ZQZXJmb3JtYW5jZSxcbiAgICBzdGF0dXM6ICdhY3RpdmUnLFxuICAgIGtleXdvcmRzOiBleHRyYWN0S2V5d29yZHMoc2FtRGF0YS50aXRsZSArICcgJyArIHNhbURhdGEuZGVzY3JpcHRpb24pLFxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICB9O1xufTtcblxuY29uc3QgZXh0cmFjdEtleXdvcmRzID0gKHRleHQ6IHN0cmluZyk6IHN0cmluZ1tdID0+IHtcbiAgLy8gU2ltcGxlIGtleXdvcmQgZXh0cmFjdGlvbiAtIGluIHByb2R1Y3Rpb24sIHVzZSBOTFBcbiAgY29uc3Qgc3RvcFdvcmRzID0gWyd0aGUnLCAnYW5kJywgJ29yJywgJ2J1dCcsICdpbicsICdvbicsICdhdCcsICd0bycsICdmb3InLCAnb2YnLCAnd2l0aCcsICdieScsICdhJywgJ2FuJ107XG4gIGNvbnN0IHdvcmRzID0gdGV4dC50b0xvd2VyQ2FzZSgpXG4gICAgLnJlcGxhY2UoL1teXFx3XFxzXS9nLCAnJylcbiAgICAuc3BsaXQoL1xccysvKVxuICAgIC5maWx0ZXIod29yZCA9PiB3b3JkLmxlbmd0aCA+IDMgJiYgIXN0b3BXb3Jkcy5pbmNsdWRlcyh3b3JkKSk7XG4gIFxuICByZXR1cm4gWy4uLm5ldyBTZXQod29yZHMpXS5zbGljZSgwLCAyMCk7IC8vIExpbWl0IHRvIDIwIHVuaXF1ZSBrZXl3b3Jkc1xufTtcblxuLy8gTWFpbiBoYW5kbGVyXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogU1FTRXZlbnQsIGNvbnRleHQ6IENvbnRleHQpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgZm9yIChjb25zdCByZWNvcmQgb2YgZXZlbnQuUmVjb3Jkcykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZXNzYWdlQm9keSA9IEpTT04ucGFyc2UocmVjb3JkLmJvZHkpO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKG1lc3NhZ2VCb2R5LnR5cGUpIHtcbiAgICAgICAgY2FzZSAnc2FtX2dvdl9kYXRhJzpcbiAgICAgICAgICBjb25zdCBvcHBvcnR1bml0eSA9IGF3YWl0IHByb2Nlc3NTQU1Hb3ZEYXRhKG1lc3NhZ2VCb2R5LmRhdGEpO1xuICAgICAgICAgIGF3YWl0IHByb2Nlc3NPcHBvcnR1bml0eShvcHBvcnR1bml0eSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnb3Bwb3J0dW5pdHlfdXBkYXRlJzpcbiAgICAgICAgICAvLyBIYW5kbGUgb3Bwb3J0dW5pdHkgdXBkYXRlc1xuICAgICAgICAgIGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogT1BQT1JUVU5JVFlfVEFCTEUsXG4gICAgICAgICAgICBLZXk6IHsgb3Bwb3J0dW5pdHlJZDogbWVzc2FnZUJvZHkuZGF0YS5vcHBvcnR1bml0eUlkIH0sXG4gICAgICAgICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNzdGF0dXMgPSA6c3RhdHVzLCB1cGRhdGVkQXQgPSA6dXBkYXRlZEF0JyxcbiAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICAgJzpzdGF0dXMnOiBtZXNzYWdlQm9keS5kYXRhLnN0YXR1cyxcbiAgICAgICAgICAgICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNvbnNvbGUud2FybignVW5rbm93biBtZXNzYWdlIHR5cGU6JywgbWVzc2FnZUJvZHkudHlwZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgcmVjb3JkOicsIGVycm9yKTtcbiAgICAgIC8vIEluIHByb2R1Y3Rpb24sIGltcGxlbWVudCBkZWFkIGxldHRlciBxdWV1ZSBoYW5kbGluZ1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG59OyJdfQ==