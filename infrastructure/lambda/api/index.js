"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_s3_1 = require("@aws-sdk/client-s3");
const client_sqs_1 = require("@aws-sdk/client-sqs");
const client_sns_1 = require("@aws-sdk/client-sns");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
// Initialize AWS clients
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const s3Client = new client_s3_1.S3Client({});
const sqsClient = new client_sqs_1.SQSClient({});
const snsClient = new client_sns_1.SNSClient({});
const eventBridgeClient = new client_eventbridge_1.EventBridgeClient({});
// Environment variables
const { STAGE, USER_TABLE, CONVERSATION_TABLE, MESSAGE_TABLE, OPPORTUNITY_TABLE, AUDIT_TABLE, DOCUMENT_BUCKET, EVENT_BUS, NOTIFICATION_TOPIC, MESSAGE_QUEUE, } = process.env;
// Utility functions
const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',
};
const createResponse = (statusCode, body, headers = {}) => ({
    statusCode,
    headers: { ...corsHeaders, ...headers },
    body: JSON.stringify(body),
});
const createAuditEvent = (userId, action, resource, details, event) => ({
    eventId: `${userId}-${action}-${Date.now()}`,
    userId,
    action,
    resource,
    timestamp: Date.now(),
    details,
    ipAddress: event.requestContext.identity.sourceIp,
    userAgent: event.requestContext.identity.userAgent,
    ttl: Math.floor(Date.now() / 1000) + (90 * 24 * 60 * 60), // 90 days
});
const logAuditEvent = async (auditEvent) => {
    try {
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: AUDIT_TABLE,
            Item: auditEvent,
        }));
        // Also send to EventBridge for real-time processing
        await eventBridgeClient.send(new client_eventbridge_1.PutEventsCommand({
            Entries: [{
                    Source: 'govbiz.audit',
                    DetailType: 'Audit Event',
                    Detail: JSON.stringify(auditEvent),
                    EventBusName: EVENT_BUS,
                }],
        }));
    }
    catch (error) {
        console.error('Failed to log audit event:', error);
    }
};
// Route handlers
const getUserProfile = async (userId) => {
    try {
        const result = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: USER_TABLE,
            Key: { userId },
        }));
        return {
            success: true,
            data: result.Item,
            timestamp: Date.now(),
            requestId: `get-user-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Get user profile error:', error);
        return {
            success: false,
            error: 'Failed to get user profile',
            timestamp: Date.now(),
            requestId: `get-user-error-${Date.now()}`,
        };
    }
};
const updateUserProfile = async (userId, profileData) => {
    try {
        const updateExpression = Object.keys(profileData)
            .map(key => `#${key} = :${key}`)
            .join(', ');
        const expressionAttributeNames = Object.keys(profileData).reduce((acc, key) => {
            acc[`#${key}`] = key;
            return acc;
        }, {});
        const expressionAttributeValues = Object.keys(profileData).reduce((acc, key) => {
            acc[`:${key}`] = profileData[key];
            return acc;
        }, {});
        const result = await docClient.send(new lib_dynamodb_1.UpdateCommand({
            TableName: USER_TABLE,
            Key: { userId },
            UpdateExpression: `SET ${updateExpression}, updatedAt = :updatedAt`,
            ExpressionAttributeNames: expressionAttributeNames,
            ExpressionAttributeValues: {
                ...expressionAttributeValues,
                ':updatedAt': new Date().toISOString(),
            },
            ReturnValues: 'ALL_NEW',
        }));
        return {
            success: true,
            data: result.Attributes,
            timestamp: Date.now(),
            requestId: `update-user-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Update user profile error:', error);
        return {
            success: false,
            error: 'Failed to update user profile',
            timestamp: Date.now(),
            requestId: `update-user-error-${Date.now()}`,
        };
    }
};
const getConversations = async (userId, limit = 20) => {
    try {
        const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: CONVERSATION_TABLE,
            IndexName: 'user-conversations-index',
            KeyConditionExpression: 'userId = :userId',
            ExpressionAttributeValues: {
                ':userId': userId,
            },
            ScanIndexForward: false,
            Limit: limit,
        }));
        return {
            success: true,
            data: {
                conversations: result.Items || [],
                count: result.Count || 0,
            },
            timestamp: Date.now(),
            requestId: `get-conversations-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Get conversations error:', error);
        return {
            success: false,
            error: 'Failed to get conversations',
            timestamp: Date.now(),
            requestId: `get-conversations-error-${Date.now()}`,
        };
    }
};
const getMessages = async (conversationId, limit = 50) => {
    try {
        const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: MESSAGE_TABLE,
            KeyConditionExpression: 'conversationId = :conversationId',
            ExpressionAttributeValues: {
                ':conversationId': conversationId,
            },
            ScanIndexForward: false,
            Limit: limit,
        }));
        return {
            success: true,
            data: {
                messages: result.Items || [],
                count: result.Count || 0,
            },
            timestamp: Date.now(),
            requestId: `get-messages-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Get messages error:', error);
        return {
            success: false,
            error: 'Failed to get messages',
            timestamp: Date.now(),
            requestId: `get-messages-error-${Date.now()}`,
        };
    }
};
const getOpportunities = async (filters = {}) => {
    try {
        let params = {
            TableName: OPPORTUNITY_TABLE,
            Limit: filters.limit || 20,
        };
        // Apply filters based on GSI
        if (filters.agency) {
            params.IndexName = 'agency-index';
            params.KeyConditionExpression = 'agency = :agency';
            params.ExpressionAttributeValues = { ':agency': filters.agency };
        }
        else if (filters.naicsCode) {
            params.IndexName = 'naics-index';
            params.KeyConditionExpression = 'naicsCode = :naicsCode';
            params.ExpressionAttributeValues = { ':naicsCode': filters.naicsCode };
        }
        else if (filters.status) {
            params.IndexName = 'status-index';
            params.KeyConditionExpression = 'status = :status';
            params.ExpressionAttributeValues = { ':status': filters.status };
        }
        const result = await docClient.send(new lib_dynamodb_1.QueryCommand(params));
        return {
            success: true,
            data: {
                opportunities: result.Items || [],
                count: result.Count || 0,
            },
            timestamp: Date.now(),
            requestId: `get-opportunities-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Get opportunities error:', error);
        return {
            success: false,
            error: 'Failed to get opportunities',
            timestamp: Date.now(),
            requestId: `get-opportunities-error-${Date.now()}`,
        };
    }
};
const processMessage = async (messageData) => {
    try {
        // Send message to SQS for async processing
        await sqsClient.send(new client_sqs_1.SendMessageCommand({
            QueueUrl: MESSAGE_QUEUE,
            MessageBody: JSON.stringify({
                type: 'chat_message',
                data: messageData,
            }),
        }));
        return {
            success: true,
            data: { messageId: messageData.messageId },
            message: 'Message queued for processing',
            timestamp: Date.now(),
            requestId: `process-message-${Date.now()}`,
        };
    }
    catch (error) {
        console.error('Process message error:', error);
        return {
            success: false,
            error: 'Failed to process message',
            timestamp: Date.now(),
            requestId: `process-message-error-${Date.now()}`,
        };
    }
};
// Main handler
const handler = async (event, context) => {
    var _a;
    console.log('Event:', JSON.stringify(event, null, 2));
    // Handle OPTIONS request for CORS
    if (event.httpMethod === 'OPTIONS') {
        return createResponse(200, {
            success: true,
            message: 'CORS preflight',
            timestamp: Date.now(),
            requestId: context.awsRequestId,
        });
    }
    try {
        const path = event.path;
        const method = event.httpMethod;
        const pathParameters = event.pathParameters || {};
        const queryStringParameters = event.queryStringParameters || {};
        const body = event.body ? JSON.parse(event.body) : {};
        // Extract user ID from headers or path
        const userId = ((_a = event.headers.Authorization) === null || _a === void 0 ? void 0 : _a.replace('Bearer ', '')) || pathParameters.userId;
        if (!userId && !path.includes('health')) {
            return createResponse(401, {
                success: false,
                error: 'Unauthorized',
                timestamp: Date.now(),
                requestId: context.awsRequestId,
            });
        }
        let response;
        // Route handling
        switch (true) {
            case path === '/health' && method === 'GET':
                response = {
                    success: true,
                    data: { status: 'healthy', stage: STAGE },
                    timestamp: Date.now(),
                    requestId: context.awsRequestId,
                };
                break;
            case path === '/user/profile' && method === 'GET':
                response = await getUserProfile(userId);
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'GET_PROFILE', 'user', {}, event));
                }
                break;
            case path === '/user/profile' && method === 'PUT':
                response = await updateUserProfile(userId, body);
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'UPDATE_PROFILE', 'user', body, event));
                }
                break;
            case path === '/conversations' && method === 'GET':
                response = await getConversations(userId, parseInt(queryStringParameters.limit || '20'));
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'GET_CONVERSATIONS', 'conversations', {}, event));
                }
                break;
            case path.startsWith('/conversations/') && path.includes('/messages') && method === 'GET':
                const conversationId = pathParameters.conversationId;
                response = await getMessages(conversationId, parseInt(queryStringParameters.limit || '50'));
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'GET_MESSAGES', 'messages', { conversationId }, event));
                }
                break;
            case path === '/opportunities' && method === 'GET':
                response = await getOpportunities(queryStringParameters);
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'GET_OPPORTUNITIES', 'opportunities', queryStringParameters, event));
                }
                break;
            case path === '/messages' && method === 'POST':
                response = await processMessage(body);
                if (response.success) {
                    await logAuditEvent(createAuditEvent(userId, 'SEND_MESSAGE', 'messages', body, event));
                }
                break;
            default:
                response = {
                    success: false,
                    error: 'Not found',
                    timestamp: Date.now(),
                    requestId: context.awsRequestId,
                };
                return createResponse(404, response);
        }
        return createResponse(200, response);
    }
    catch (error) {
        console.error('Handler error:', error);
        return createResponse(500, {
            success: false,
            error: 'Internal server error',
            timestamp: Date.now(),
            requestId: context.awsRequestId,
        });
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQWlJO0FBQ2pJLGtEQUFrRjtBQUNsRixvREFBb0U7QUFDcEUsb0RBQWdFO0FBQ2hFLG9FQUFrRjtBQUVsRix5QkFBeUI7QUFDekIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxzQkFBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sU0FBUyxHQUFHLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNwQyxNQUFNLGlCQUFpQixHQUFHLElBQUksc0NBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFcEQsd0JBQXdCO0FBQ3hCLE1BQU0sRUFDSixLQUFLLEVBQ0wsVUFBVSxFQUNWLGtCQUFrQixFQUNsQixhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLFdBQVcsRUFDWCxlQUFlLEVBQ2YsU0FBUyxFQUNULGtCQUFrQixFQUNsQixhQUFhLEdBQ2QsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBd0JoQixvQkFBb0I7QUFDcEIsTUFBTSxXQUFXLEdBQUc7SUFDbEIsNkJBQTZCLEVBQUUsR0FBRztJQUNsQyw4QkFBOEIsRUFBRSw0QkFBNEI7SUFDNUQsOEJBQThCLEVBQUUsNkJBQTZCO0NBQzlELENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxDQUNyQixVQUFrQixFQUNsQixJQUFpQixFQUNqQixVQUFrQyxFQUFFLEVBQ2IsRUFBRSxDQUFDLENBQUM7SUFDM0IsVUFBVTtJQUNWLE9BQU8sRUFBRSxFQUFF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QUFDLFlBQVk7aUJBQ2hDLENBQUM7Z0JBQ0YsT0FBTyxjQUFjLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFFRCxPQUFPLGNBQWMsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sY0FBYyxDQUFDLEdBQUcsRUFBRTtZQUN6QixPQUFPLEVBQUUsS0FBSztZQUNkLEtBQUssRUFBRSx1QkFBdUI7WUFDOUIsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDckIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxZQUFZO1NBQ2hDLENBQUMsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDLENBQUM7QUEvR1csUUFBQSxPQUFPLFdBK0dsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIFB1dENvbW1hbmQsIFVwZGF0ZUNvbW1hbmQsIFF1ZXJ5Q29tbWFuZCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgUzNDbGllbnQsIEdldE9iamVjdENvbW1hbmQsIFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgU1FTQ2xpZW50LCBTZW5kTWVzc2FnZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc3FzJztcbmltcG9ydCB7IFNOU0NsaWVudCwgUHVibGlzaENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc25zJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcblxuLy8gSW5pdGlhbGl6ZSBBV1MgY2xpZW50c1xuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe30pO1xuY29uc3Qgc3FzQ2xpZW50ID0gbmV3IFNRU0NsaWVudCh7fSk7XG5jb25zdCBzbnNDbGllbnQgPSBuZXcgU05TQ2xpZW50KHt9KTtcbmNvbnN0IGV2ZW50QnJpZGdlQ2xpZW50ID0gbmV3IEV2ZW50QnJpZGdlQ2xpZW50KHt9KTtcblxuLy8gRW52aXJvbm1lbnQgdmFyaWFibGVzXG5jb25zdCB7XG4gIFNUQUdFLFxuICBVU0VSX1RBQkxFLFxuICBDT05WRVJTQVRJT05fVEFCTEUsXG4gIE1FU1NBR0VfVEFCTEUsXG4gIE9QUE9SVFVOSVRZX1RBQkxFLFxuICBBVURJVF9UQUJMRSxcbiAgRE9DVU1FTlRfQlVDS0VULFxuICBFVkVOVF9CVVMsXG4gIE5PVElGSUNBVElPTl9UT1BJQyxcbiAgTUVTU0FHRV9RVUVVRSxcbn0gPSBwcm9jZXNzLmVudjtcblxuLy8gVHlwZXNcbmludGVyZmFjZSBBUElSZXNwb25zZSB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIGRhdGE/OiBhbnk7XG4gIGVycm9yPzogc3RyaW5nO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgcmVxdWVzdElkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBBdWRpdEV2ZW50IHtcbiAgZXZlbnRJZDogc3RyaW5nO1xuICB1c2VySWQ6IHN0cmluZztcbiAgYWN0aW9uOiBzdHJpbmc7XG4gIHJlc291cmNlOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICBkZXRhaWxzOiBhbnk7XG4gIGlwQWRkcmVzcz86IHN0cmluZztcbiAgdXNlckFnZW50Pzogc3RyaW5nO1xuICB0dGw6IG51bWJlcjtcbn1cblxuLy8gVXRpbGl0eSBmdW5jdGlvbnNcbmNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULFBVVCxERUxFVEUsT1BUSU9OUycsXG59O1xuXG5jb25zdCBjcmVhdGVSZXNwb25zZSA9IChcbiAgc3RhdHVzQ29kZTogbnVtYmVyLFxuICBib2R5OiBBUElSZXNwb25zZSxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9XG4pOiBBUElHYXRld2F5UHJveHlSZXN1bHQgPT4gKHtcbiAgc3RhdHVzQ29kZSxcbiAgaGVhZGVyczogeyAuLi5jb3JzSGVhZGVycywgLi4uaGVhZGVycyB9LFxuICBib2R5OiBKU09OLnN0cmluZ2lmeShib2R5KSxcbn0pO1xuXG5jb25zdCBjcmVhdGVBdWRpdEV2ZW50ID0gKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgYWN0aW9uOiBzdHJpbmcsXG4gIHJlc291cmNlOiBzdHJpbmcsXG4gIGRldGFpbHM6IGFueSxcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50XG4pOiBBdWRpdEV2ZW50ID0+ICh7XG4gIGV2ZW50SWQ6IGAke3VzZXJJZH0tJHthY3Rpb259LSR7RGF0ZS5ub3coKX1gLFxuICB1c2VySWQsXG4gIGFjdGlvbixcbiAgcmVzb3VyY2UsXG4gIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgZGV0YWlscyxcbiAgaXBBZGRyZXNzOiBldmVudC5yZXF1ZXN0Q29udGV4dC5pZGVudGl0eS5zb3VyY2VJcCxcbiAgdXNlckFnZW50OiBldmVudC5yZXF1ZXN0Q29udGV4dC5pZGVudGl0eS51c2VyQWdlbnQsXG4gIHR0bDogTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCkgKyAoOTAgKiAyNCAqIDYwICogNjApLCAvLyA5MCBkYXlzXG59KTtcblxuY29uc3QgbG9nQXVkaXRFdmVudCA9IGFzeW5jIChhdWRpdEV2ZW50OiBBdWRpdEV2ZW50KSA9PiB7XG4gIHRyeSB7XG4gICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBBVURJVF9UQUJMRSxcbiAgICAgIEl0ZW06IGF1ZGl0RXZlbnQsXG4gICAgfSkpO1xuXG4gICAgLy8gQWxzbyBzZW5kIHRvIEV2ZW50QnJpZGdlIGZvciByZWFsLXRpbWUgcHJvY2Vzc2luZ1xuICAgIGF3YWl0IGV2ZW50QnJpZGdlQ2xpZW50LnNlbmQobmV3IFB1dEV2ZW50c0NvbW1hbmQoe1xuICAgICAgRW50cmllczogW3tcbiAgICAgICAgU291cmNlOiAnZ292Yml6LmF1ZGl0JyxcbiAgICAgICAgRGV0YWlsVHlwZTogJ0F1ZGl0IEV2ZW50JyxcbiAgICAgICAgRGV0YWlsOiBKU09OLnN0cmluZ2lmeShhdWRpdEV2ZW50KSxcbiAgICAgICAgRXZlbnRCdXNOYW1lOiBFVkVOVF9CVVMsXG4gICAgICB9XSxcbiAgICB9KSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGxvZyBhdWRpdCBldmVudDonLCBlcnJvcik7XG4gIH1cbn07XG5cbi8vIFJvdXRlIGhhbmRsZXJzXG5jb25zdCBnZXRVc2VyUHJvZmlsZSA9IGFzeW5jICh1c2VySWQ6IHN0cmluZyk6IFByb21pc2U8QVBJUmVzcG9uc2U+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgR2V0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFVTRVJfVEFCTEUsXG4gICAgICBLZXk6IHsgdXNlcklkIH0sXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiByZXN1bHQuSXRlbSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYGdldC11c2VyLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignR2V0IHVzZXIgcHJvZmlsZSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IHVzZXIgcHJvZmlsZScsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICByZXF1ZXN0SWQ6IGBnZXQtdXNlci1lcnJvci0ke0RhdGUubm93KCl9YCxcbiAgICB9O1xuICB9XG59O1xuXG5jb25zdCB1cGRhdGVVc2VyUHJvZmlsZSA9IGFzeW5jICh1c2VySWQ6IHN0cmluZywgcHJvZmlsZURhdGE6IGFueSk6IFByb21pc2U8QVBJUmVzcG9uc2U+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1cGRhdGVFeHByZXNzaW9uID0gT2JqZWN0LmtleXMocHJvZmlsZURhdGEpXG4gICAgICAubWFwKGtleSA9PiBgIyR7a2V5fSA9IDoke2tleX1gKVxuICAgICAgLmpvaW4oJywgJyk7XG5cbiAgICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlRGF0YSkucmVkdWNlKChhY2MsIGtleSkgPT4ge1xuICAgICAgYWNjW2AjJHtrZXl9YF0gPSBrZXk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4pO1xuXG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVEYXRhKS5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XG4gICAgICBhY2NbYDoke2tleX1gXSA9IHByb2ZpbGVEYXRhW2tleV07XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIGFueT4pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBVU0VSX1RBQkxFLFxuICAgICAgS2V5OiB7IHVzZXJJZCB9LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb259LCB1cGRhdGVkQXQgPSA6dXBkYXRlZEF0YCxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAuLi5leHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAnOnVwZGF0ZWRBdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgIH0sXG4gICAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJyxcbiAgICB9KSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHJlc3VsdC5BdHRyaWJ1dGVzLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgcmVxdWVzdElkOiBgdXBkYXRlLXVzZXItJHtEYXRlLm5vdygpfWAsXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdVcGRhdGUgdXNlciBwcm9maWxlIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ZhaWxlZCB0byB1cGRhdGUgdXNlciBwcm9maWxlJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYHVwZGF0ZS11c2VyLWVycm9yLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH1cbn07XG5cbmNvbnN0IGdldENvbnZlcnNhdGlvbnMgPSBhc3luYyAodXNlcklkOiBzdHJpbmcsIGxpbWl0OiBudW1iZXIgPSAyMCk6IFByb21pc2U8QVBJUmVzcG9uc2U+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQ09OVkVSU0FUSU9OX1RBQkxFLFxuICAgICAgSW5kZXhOYW1lOiAndXNlci1jb252ZXJzYXRpb25zLWluZGV4JyxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICd1c2VySWQgPSA6dXNlcklkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzp1c2VySWQnOiB1c2VySWQsXG4gICAgICB9LFxuICAgICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UsXG4gICAgICBMaW1pdDogbGltaXQsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGNvbnZlcnNhdGlvbnM6IHJlc3VsdC5JdGVtcyB8fCBbXSxcbiAgICAgICAgY291bnQ6IHJlc3VsdC5Db3VudCB8fCAwLFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYGdldC1jb252ZXJzYXRpb25zLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignR2V0IGNvbnZlcnNhdGlvbnMgZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGdldCBjb252ZXJzYXRpb25zJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYGdldC1jb252ZXJzYXRpb25zLWVycm9yLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH1cbn07XG5cbmNvbnN0IGdldE1lc3NhZ2VzID0gYXN5bmMgKGNvbnZlcnNhdGlvbklkOiBzdHJpbmcsIGxpbWl0OiBudW1iZXIgPSA1MCk6IFByb21pc2U8QVBJUmVzcG9uc2U+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogTUVTU0FHRV9UQUJMRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdjb252ZXJzYXRpb25JZCA9IDpjb252ZXJzYXRpb25JZCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6Y29udmVyc2F0aW9uSWQnOiBjb252ZXJzYXRpb25JZCxcbiAgICAgIH0sXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSxcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgbWVzc2FnZXM6IHJlc3VsdC5JdGVtcyB8fCBbXSxcbiAgICAgICAgY291bnQ6IHJlc3VsdC5Db3VudCB8fCAwLFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYGdldC1tZXNzYWdlcy0ke0RhdGUubm93KCl9YCxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0dldCBtZXNzYWdlcyBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gZ2V0IG1lc3NhZ2VzJyxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlcXVlc3RJZDogYGdldC1tZXNzYWdlcy1lcnJvci0ke0RhdGUubm93KCl9YCxcbiAgICB9O1xuICB9XG59O1xuXG5jb25zdCBnZXRPcHBvcnR1bml0aWVzID0gYXN5bmMgKGZpbHRlcnM6IGFueSA9IHt9KTogUHJvbWlzZTxBUElSZXNwb25zZT4gPT4ge1xuICB0cnkge1xuICAgIGxldCBwYXJhbXM6IGFueSA9IHtcbiAgICAgIFRhYmxlTmFtZTogT1BQT1JUVU5JVFlfVEFCTEUsXG4gICAgICBMaW1pdDogZmlsdGVycy5saW1pdCB8fCAyMCxcbiAgICB9O1xuXG4gICAgLy8gQXBwbHkgZmlsdGVycyBiYXNlZCBvbiBHU0lcbiAgICBpZiAoZmlsdGVycy5hZ2VuY3kpIHtcbiAgICAgIHBhcmFtcy5JbmRleE5hbWUgPSAnYWdlbmN5LWluZGV4JztcbiAgICAgIHBhcmFtcy5LZXlDb25kaXRpb25FeHByZXNzaW9uID0gJ2FnZW5jeSA9IDphZ2VuY3knO1xuICAgICAgcGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7ICc6YWdlbmN5JzogZmlsdGVycy5hZ2VuY3kgfTtcbiAgICB9IGVsc2UgaWYgKGZpbHRlcnMubmFpY3NDb2RlKSB7XG4gICAgICBwYXJhbXMuSW5kZXhOYW1lID0gJ25haWNzLWluZGV4JztcbiAgICAgIHBhcmFtcy5LZXlDb25kaXRpb25FeHByZXNzaW9uID0gJ25haWNzQ29kZSA9IDpuYWljc0NvZGUnO1xuICAgICAgcGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPSB7ICc6bmFpY3NDb2RlJzogZmlsdGVycy5uYWljc0NvZGUgfTtcbiAgICB9IGVsc2UgaWYgKGZpbHRlcnMuc3RhdHVzKSB7XG4gICAgICBwYXJhbXMuSW5kZXhOYW1lID0gJ3N0YXR1cy1pbmRleCc7XG4gICAgICBwYXJhbXMuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiA9ICdzdGF0dXMgPSA6c3RhdHVzJztcbiAgICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzID0geyAnOnN0YXR1cyc6IGZpbHRlcnMuc3RhdHVzIH07XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBvcHBvcnR1bml0aWVzOiByZXN1bHQuSXRlbXMgfHwgW10sXG4gICAgICAgIGNvdW50OiByZXN1bHQuQ291bnQgfHwgMCxcbiAgICAgIH0sXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICByZXF1ZXN0SWQ6IGBnZXQtb3Bwb3J0dW5pdGllcy0ke0RhdGUubm93KCl9YCxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0dldCBvcHBvcnR1bml0aWVzIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ZhaWxlZCB0byBnZXQgb3Bwb3J0dW5pdGllcycsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICByZXF1ZXN0SWQ6IGBnZXQtb3Bwb3J0dW5pdGllcy1lcnJvci0ke0RhdGUubm93KCl9YCxcbiAgICB9O1xuICB9XG59O1xuXG5jb25zdCBwcm9jZXNzTWVzc2FnZSA9IGFzeW5jIChtZXNzYWdlRGF0YTogYW55KTogUHJvbWlzZTxBUElSZXNwb25zZT4gPT4ge1xuICB0cnkge1xuICAgIC8vIFNlbmQgbWVzc2FnZSB0byBTUVMgZm9yIGFzeW5jIHByb2Nlc3NpbmdcbiAgICBhd2FpdCBzcXNDbGllbnQuc2VuZChuZXcgU2VuZE1lc3NhZ2VDb21tYW5kKHtcbiAgICAgIFF1ZXVlVXJsOiBNRVNTQUdFX1FVRVVFLFxuICAgICAgTWVzc2FnZUJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgdHlwZTogJ2NoYXRfbWVzc2FnZScsXG4gICAgICAgIGRhdGE6IG1lc3NhZ2VEYXRhLFxuICAgICAgfSksXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBkYXRhOiB7IG1lc3NhZ2VJZDogbWVzc2FnZURhdGEubWVzc2FnZUlkIH0sXG4gICAgICBtZXNzYWdlOiAnTWVzc2FnZSBxdWV1ZWQgZm9yIHByb2Nlc3NpbmcnLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgcmVxdWVzdElkOiBgcHJvY2Vzcy1tZXNzYWdlLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignUHJvY2VzcyBtZXNzYWdlIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogJ0ZhaWxlZCB0byBwcm9jZXNzIG1lc3NhZ2UnLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgcmVxdWVzdElkOiBgcHJvY2Vzcy1tZXNzYWdlLWVycm9yLSR7RGF0ZS5ub3coKX1gLFxuICAgIH07XG4gIH1cbn07XG5cbi8vIE1haW4gaGFuZGxlclxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcbiAgY29udGV4dDogQ29udGV4dFxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgLy8gSGFuZGxlIE9QVElPTlMgcmVxdWVzdCBmb3IgQ09SU1xuICBpZiAoZXZlbnQuaHR0cE1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwge1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIG1lc3NhZ2U6ICdDT1JTIHByZWZsaWdodCcsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxuICAgIH0pO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBwYXRoID0gZXZlbnQucGF0aDtcbiAgICBjb25zdCBtZXRob2QgPSBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IHBhdGhQYXJhbWV0ZXJzID0gZXZlbnQucGF0aFBhcmFtZXRlcnMgfHwge307XG4gICAgY29uc3QgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuICAgIGNvbnN0IGJvZHkgPSBldmVudC5ib2R5ID8gSlNPTi5wYXJzZShldmVudC5ib2R5KSA6IHt9O1xuXG4gICAgLy8gRXh0cmFjdCB1c2VyIElEIGZyb20gaGVhZGVycyBvciBwYXRoXG4gICAgY29uc3QgdXNlcklkID0gZXZlbnQuaGVhZGVycy5BdXRob3JpemF0aW9uPy5yZXBsYWNlKCdCZWFyZXIgJywgJycpIHx8IHBhdGhQYXJhbWV0ZXJzLnVzZXJJZDtcblxuICAgIGlmICghdXNlcklkICYmICFwYXRoLmluY2x1ZGVzKCdoZWFsdGgnKSkge1xuICAgICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDQwMSwge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdVbmF1dGhvcml6ZWQnLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgIHJlcXVlc3RJZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsZXQgcmVzcG9uc2U6IEFQSVJlc3BvbnNlO1xuXG4gICAgLy8gUm91dGUgaGFuZGxpbmdcbiAgICBzd2l0Y2ggKHRydWUpIHtcbiAgICAgIGNhc2UgcGF0aCA9PT0gJy9oZWFsdGgnICYmIG1ldGhvZCA9PT0gJ0dFVCc6XG4gICAgICAgIHJlc3BvbnNlID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgZGF0YTogeyBzdGF0dXM6ICdoZWFsdGh5Jywgc3RhZ2U6IFNUQUdFIH0sXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgIHJlcXVlc3RJZDogY29udGV4dC5hd3NSZXF1ZXN0SWQsXG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIHBhdGggPT09ICcvdXNlci9wcm9maWxlJyAmJiBtZXRob2QgPT09ICdHRVQnOlxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IGdldFVzZXJQcm9maWxlKHVzZXJJZCEpO1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0F1ZGl0RXZlbnQoY3JlYXRlQXVkaXRFdmVudCh1c2VySWQhLCAnR0VUX1BST0ZJTEUnLCAndXNlcicsIHt9LCBldmVudCkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIHBhdGggPT09ICcvdXNlci9wcm9maWxlJyAmJiBtZXRob2QgPT09ICdQVVQnOlxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IHVwZGF0ZVVzZXJQcm9maWxlKHVzZXJJZCEsIGJvZHkpO1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0F1ZGl0RXZlbnQoY3JlYXRlQXVkaXRFdmVudCh1c2VySWQhLCAnVVBEQVRFX1BST0ZJTEUnLCAndXNlcicsIGJvZHksIGV2ZW50KSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgcGF0aCA9PT0gJy9jb252ZXJzYXRpb25zJyAmJiBtZXRob2QgPT09ICdHRVQnOlxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IGdldENvbnZlcnNhdGlvbnModXNlcklkISwgcGFyc2VJbnQocXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmxpbWl0IHx8ICcyMCcpKTtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MpIHtcbiAgICAgICAgICBhd2FpdCBsb2dBdWRpdEV2ZW50KGNyZWF0ZUF1ZGl0RXZlbnQodXNlcklkISwgJ0dFVF9DT05WRVJTQVRJT05TJywgJ2NvbnZlcnNhdGlvbnMnLCB7fSwgZXZlbnQpKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBwYXRoLnN0YXJ0c1dpdGgoJy9jb252ZXJzYXRpb25zLycpICYmIHBhdGguaW5jbHVkZXMoJy9tZXNzYWdlcycpICYmIG1ldGhvZCA9PT0gJ0dFVCc6XG4gICAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbklkID0gcGF0aFBhcmFtZXRlcnMuY29udmVyc2F0aW9uSWQ7XG4gICAgICAgIHJlc3BvbnNlID0gYXdhaXQgZ2V0TWVzc2FnZXMoY29udmVyc2F0aW9uSWQhLCBwYXJzZUludChxdWVyeVN0cmluZ1BhcmFtZXRlcnMubGltaXQgfHwgJzUwJykpO1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0F1ZGl0RXZlbnQoY3JlYXRlQXVkaXRFdmVudCh1c2VySWQhLCAnR0VUX01FU1NBR0VTJywgJ21lc3NhZ2VzJywgeyBjb252ZXJzYXRpb25JZCB9LCBldmVudCkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIHBhdGggPT09ICcvb3Bwb3J0dW5pdGllcycgJiYgbWV0aG9kID09PSAnR0VUJzpcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBnZXRPcHBvcnR1bml0aWVzKHF1ZXJ5U3RyaW5nUGFyYW1ldGVycyk7XG4gICAgICAgIGlmIChyZXNwb25zZS5zdWNjZXNzKSB7XG4gICAgICAgICAgYXdhaXQgbG9nQXVkaXRFdmVudChjcmVhdGVBdWRpdEV2ZW50KHVzZXJJZCEsICdHRVRfT1BQT1JUVU5JVElFUycsICdvcHBvcnR1bml0aWVzJywgcXVlcnlTdHJpbmdQYXJhbWV0ZXJzLCBldmVudCkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIHBhdGggPT09ICcvbWVzc2FnZXMnICYmIG1ldGhvZCA9PT0gJ1BPU1QnOlxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IHByb2Nlc3NNZXNzYWdlKGJvZHkpO1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgIGF3YWl0IGxvZ0F1ZGl0RXZlbnQoY3JlYXRlQXVkaXRFdmVudCh1c2VySWQhLCAnU0VORF9NRVNTQUdFJywgJ21lc3NhZ2VzJywgYm9keSwgZXZlbnQpKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmVzcG9uc2UgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdOb3QgZm91bmQnLFxuICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY3JlYXRlUmVzcG9uc2UoNDA0LCByZXNwb25zZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNyZWF0ZVJlc3BvbnNlKDIwMCwgcmVzcG9uc2UpO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0hhbmRsZXIgZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiBjcmVhdGVSZXNwb25zZSg1MDAsIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgcmVxdWVzdElkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcbiAgICB9KTtcbiAgfVxufTsiXX0=